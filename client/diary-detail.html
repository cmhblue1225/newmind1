<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>일기 상세 보기</title>
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #f8f9fa;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      padding-bottom: 100px;
    }

    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      color: #339af0;
      font-weight: bold;
      text-decoration: none;
    }

    .diary-box {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .diary-box p {
      margin: 0.5rem 0;
      line-height: 1.5;
    }

    .label {
      font-weight: bold;
    }

    #feedback-box {
      background: #fff3bf;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }

    .chat-btn, .delete-btn {
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      background: #339af0;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 0.5rem auto;
      display: block;
      width: fit-content;
    }

    .delete-btn {
      background: #fa5252;
    }

    .music-recommendation-card {
      background: #ffffff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }

    .music-recommendation-card h3 {
      margin-bottom: 0.6rem;
    }

    .music-recommendation-card p {
      margin: 0.4rem 0;
    }

    .listen-button {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      background-color: #339af0;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <a href="my-diary.html" class="back-btn">← 내 일기 목록으로</a>

  <h1>📘 일기 상세</h1>

  <div class="diary-box">
    <p><span class="label">🕒 작성일:</span> <span id="created-at"></span></p>
    <p><span class="label">💬 감정:</span> <span id="emotion"></span></p>
    <p><span class="label">📝 내용:</span></p>
    <p id="content"></p>
  </div>

  <div id="feedback-box" style="display: none;"></div>

  <button class="chat-btn" id="chat-btn">💬 이 일기로 AI 상담 시작</button>
  <button class="delete-btn" id="delete-btn">🗑️ 일기 삭제</button>

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';

    checkAuth();

    const params = new URLSearchParams(location.search);
    const diaryId = params.get('id');
    const feedbackBox = document.getElementById('feedback-box');

    async function loadDiary() {
      if (!diaryId) return alert('일기를 찾을 수 없습니다.');

      const { data, error } = await supabase.from('diaries').select('*').eq('id', diaryId).single();
      if (error || !data) return alert('일기 불러오기 실패');

      const utc = new Date(data.created_at);
      const kst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
      document.getElementById('created-at').textContent = kst.toLocaleString('ko-KR');
      document.getElementById('emotion').textContent = data.emotion;
      document.getElementById('content').textContent = data.content;

      const res = await fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ diaryContent: data.content, selectedEmotion: data.emotion })
      });

      const gpt = await res.json();
      if (gpt.feedback) {
        const parsed = parseFeedback(gpt.feedback);
        feedbackBox.style.display = 'block';
        const musicButtons = `
          <a href="${parsed.youtube}" target="_blank" class="listen-button">▶️ 유튜브에서 듣기</a>
          ${parsed.spotify ? `<a href="${parsed.spotify}" target="_blank" class="listen-button" style="background-color: #1db954; margin-left: 0.5rem;">🎵 Spotify에서 듣기</a>` : ''}
        `;

        feedbackBox.innerHTML = `
          <div class="music-recommendation-card">
            <p><strong>✨ 감성 피드백:</strong> ${parsed.feedback}</p>
            <h3>🎵 추천곡: ${parsed.song}</h3>
            <p>🎤 가수: ${parsed.artist}</p>
            <p>🎼 장르: ${parsed.genre}</p>
            <p>📝 추천 이유: ${parsed.reason}</p>
            ${musicButtons}
          </div>
        `;
      }
    }

    function parseFeedback(text) {
      const feedbackMatch = text.match(/✨ 감성 피드백:\s*(.*)/);
      const songMatch = text.match(/🎵 추천곡 제목:\s*(.*)/);
      const artistMatch = text.match(/🎤 가수:\s*(.*)/);
      const reasonMatch = text.match(/📝 추천 이유:\s*(.*)/);
      const genreMatch = text.match(/🎼 장르:\s*(.*)/);
      const youtubeMatch = text.match(/▶️ 유튜브 링크:\s*(.*)/);
      const spotifyMatch = text.match(/🎵 Spotify 링크:\s*(.*)/);

      let youtubeLink = youtubeMatch ? youtubeMatch[1].trim() : '#';
      const markdownLinkMatch = youtubeLink.match(/\((https?:\/\/[^\s)]+)\)/);
      if (markdownLinkMatch) {
        youtubeLink = markdownLinkMatch[1];
      } else if (!youtubeLink.startsWith('http')) {
        youtubeLink = '#';
      }

      let spotifyLink = spotifyMatch ? spotifyMatch[1].trim() : null;

      return {
        feedback: feedbackMatch ? feedbackMatch[1].trim() : '없음',
        song: songMatch ? songMatch[1].trim() : '제목 없음',
        artist: artistMatch ? artistMatch[1].trim() : '가수 없음',
        reason: reasonMatch ? reasonMatch[1].trim() : '추천 이유 없음',
        genre: genreMatch ? genreMatch[1].trim() : '장르 정보 없음',
        youtube: youtubeLink,
        spotify: spotifyLink
      };
    }

    document.getElementById('chat-btn').addEventListener('click', () => {
      location.href = `chat.html?id=${diaryId}`;
    });

    document.getElementById('delete-btn').addEventListener('click', async () => {
      const confirmDelete = confirm('정말로 이 일기를 삭제하시겠습니까?');
      if (!confirmDelete) return;

      const { error } = await supabase.from('diaries').delete().eq('id', diaryId);
      if (error) {
        alert('삭제 실패: ' + error.message);
      } else {
        alert('일기가 삭제되었습니다.');
        location.href = 'my-diary.html';
      }
    });

    loadDiary();
  </script>
</body>
</html>
