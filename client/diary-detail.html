<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¼ê¸° ìƒì„¸ ë³´ê¸°</title>
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #f8f9fa;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      padding-bottom: 100px;
    }

    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      color: #339af0;
      font-weight: bold;
      text-decoration: none;
    }

    .diary-box {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .diary-box p {
      margin: 0.5rem 0;
      line-height: 1.5;
    }

    .label {
      font-weight: bold;
    }

    #feedback-box {
      background: #fff3bf;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }

    .chat-btn, .delete-btn {
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      background: #339af0;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 0.5rem auto;
      display: block;
      width: fit-content;
    }

    .delete-btn {
      background: #fa5252;
    }

    .music-recommendation-card {
      background: #ffffff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }

    .music-recommendation-card h3 {
      margin-bottom: 0.6rem;
    }

    .music-recommendation-card p {
      margin: 0.4rem 0;
    }

    .listen-button {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      background-color: #339af0;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <a href="my-diary.html" class="back-btn">â† ë‚´ ì¼ê¸° ëª©ë¡ìœ¼ë¡œ</a>

  <h1>ğŸ“˜ ì¼ê¸° ìƒì„¸</h1>

  <div class="diary-box">
    <p><span class="label">ğŸ•’ ì‘ì„±ì¼:</span> <span id="created-at"></span></p>
    <p><span class="label">ğŸ’¬ ê°ì •:</span> <span id="emotion"></span></p>
    <p><span class="label">ğŸ“ ë‚´ìš©:</span></p>
    <p id="content"></p>
  </div>

  <div id="feedback-box" style="display: none;"></div>

  <button class="chat-btn" id="chat-btn">ğŸ’¬ ì´ ì¼ê¸°ë¡œ AI ìƒë‹´ ì‹œì‘</button>
  <button class="delete-btn" id="delete-btn">ğŸ—‘ï¸ ì¼ê¸° ì‚­ì œ</button>

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';

    checkAuth();

    const params = new URLSearchParams(location.search);
    const diaryId = params.get('id');
    const feedbackBox = document.getElementById('feedback-box');

    async function loadDiary() {
      if (!diaryId) return alert('ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      const { data, error } = await supabase.from('diaries').select('*').eq('id', diaryId).single();
      if (error || !data) return alert('ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

      const utc = new Date(data.created_at);
      const kst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
      document.getElementById('created-at').textContent = kst.toLocaleString('ko-KR');
      document.getElementById('emotion').textContent = data.emotion;
      document.getElementById('content').textContent = data.content;

      const res = await fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ diaryContent: data.content, selectedEmotion: data.emotion })
      });

      const gpt = await res.json();
      if (gpt.feedback) {
        const parsed = parseFeedback(gpt.feedback);
        feedbackBox.style.display = 'block';
        const musicButtons = `
          <a href="${parsed.youtube}" target="_blank" class="listen-button">â–¶ï¸ ìœ íŠœë¸Œì—ì„œ ë“£ê¸°</a>
          ${parsed.spotify ? `<a href="${parsed.spotify}" target="_blank" class="listen-button" style="background-color: #1db954; margin-left: 0.5rem;">ğŸµ Spotifyì—ì„œ ë“£ê¸°</a>` : ''}
        `;

        feedbackBox.innerHTML = `
          <div class="music-recommendation-card">
            <p><strong>âœ¨ ê°ì„± í”¼ë“œë°±:</strong> ${parsed.feedback}</p>
            <h3>ğŸµ ì¶”ì²œê³¡: ${parsed.song}</h3>
            <p>ğŸ¤ ê°€ìˆ˜: ${parsed.artist}</p>
            <p>ğŸ¼ ì¥ë¥´: ${parsed.genre}</p>
            <p>ğŸ“ ì¶”ì²œ ì´ìœ : ${parsed.reason}</p>
            ${musicButtons}
          </div>
        `;
      }
    }

    function parseFeedback(text) {
      const feedbackMatch = text.match(/âœ¨ ê°ì„± í”¼ë“œë°±:\s*(.*)/);
      const songMatch = text.match(/ğŸµ ì¶”ì²œê³¡ ì œëª©:\s*(.*)/);
      const artistMatch = text.match(/ğŸ¤ ê°€ìˆ˜:\s*(.*)/);
      const reasonMatch = text.match(/ğŸ“ ì¶”ì²œ ì´ìœ :\s*(.*)/);
      const genreMatch = text.match(/ğŸ¼ ì¥ë¥´:\s*(.*)/);
      const youtubeMatch = text.match(/â–¶ï¸ ìœ íŠœë¸Œ ë§í¬:\s*(.*)/);
      const spotifyMatch = text.match(/ğŸµ Spotify ë§í¬:\s*(.*)/);

      let youtubeLink = youtubeMatch ? youtubeMatch[1].trim() : '#';
      const markdownLinkMatch = youtubeLink.match(/\((https?:\/\/[^\s)]+)\)/);
      if (markdownLinkMatch) {
        youtubeLink = markdownLinkMatch[1];
      } else if (!youtubeLink.startsWith('http')) {
        youtubeLink = '#';
      }

      let spotifyLink = spotifyMatch ? spotifyMatch[1].trim() : null;

      return {
        feedback: feedbackMatch ? feedbackMatch[1].trim() : 'ì—†ìŒ',
        song: songMatch ? songMatch[1].trim() : 'ì œëª© ì—†ìŒ',
        artist: artistMatch ? artistMatch[1].trim() : 'ê°€ìˆ˜ ì—†ìŒ',
        reason: reasonMatch ? reasonMatch[1].trim() : 'ì¶”ì²œ ì´ìœ  ì—†ìŒ',
        genre: genreMatch ? genreMatch[1].trim() : 'ì¥ë¥´ ì •ë³´ ì—†ìŒ',
        youtube: youtubeLink,
        spotify: spotifyLink
      };
    }

    document.getElementById('chat-btn').addEventListener('click', () => {
      location.href = `chat.html?id=${diaryId}`;
    });

    document.getElementById('delete-btn').addEventListener('click', async () => {
      const confirmDelete = confirm('ì •ë§ë¡œ ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      if (!confirmDelete) return;

      const { error } = await supabase.from('diaries').delete().eq('id', diaryId);
      if (error) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      } else {
        alert('ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = 'my-diary.html';
      }
    });

    loadDiary();
  </script>
</body>
</html>
